# Viewer Application Documentation

## Overview

The **Viewer** is a specialized front-end application designed for visualizing and interacting with the **Surface Node Map** and **TSA (Tree Search Algorithm)** math engine key components. It serves as an interactive debugger and demonstration tool for the math learning system.

The core purpose of the Viewer is to render mathematical formulas using [KaTeX](https://katex.org/), build a semantic interaction layer ("Surface Node Map") on top of the rendered DOM, and facilitate testing of mathematical operations and state transitions.

## Technology Stack

- **Core**: Vanilla HTML5, CSS3, ES Modules (JavaScript).
- **Rendering**: [KaTeX](https://katex.org/) for high-quality math typesetting.
- **Server**: Minimal Node.js HTTP server (`tiny-server.js`) for local development.
- **Package Manager**: `pnpm`.
- **Dependencies**:
  - `nodemon`: For development server reloading.

## Directory Structure

```
viewer/
├── index.html          # Main application entry point
├── server.js           # Minimal static file server
├── package.json        # Project metadata and scripts
├── src/
│   ├── app/            # Application logic
│   │   ├── main.js     # Main specific entry point
│   │   ├── ast-parser/ # logic for parsing raw expressions
│   │   ├── core/       # Core state and definitions
│   │   ├── features/   # Feature modules (debug, engine, events, etc.)
│   │   ├── surface-map/# Surface Node Map construction & logic
│   │   └── ui/         # UI components
│   └── assets/         # Static assets (CSS, KaTeX libs)
```

## Key Features

### 1. Surface Node Map

The application builds a "Surface Node Map" by analyzing the DOM structure generated by KaTeX. This map associates visual elements (numbers, operators, fraction bars) with semantic meaning, allowing for:

- **Element Classification**: Identifying digits, symbols, and structural elements.
- **Bounding Box Analysis**: Accurate geometric mapping of mathematical terms.
- **Hit Testing**: Detecting which mathematical node is under the cursor.

### 2. Interactive Formula Editing

Users can interact with the rendered formula:

- **Click Selection**: Select specific nodes (numbers, variables).
- **Drag Selection**: Select ranges of terms.
- **Manual Input**: Input raw LaTeX strings to test rendering and mapping.

### 3. Debugging & Introspection

Extensive debugging tools are built-in:

- **Hover Panels**: display real-time info about the node under the cursor.
- **Event Logging**: Tracks clicks, engine requests, and client events.
- **Steps Log**: Visualizes the TSA steps and decision process.
- **JSON Exports**: Ability to download the constructed Surface Map, event logs, and session snapshots.

### 4. Test Suites

The viewer includes predefined test cases (`T0` - `T13`) covering various mathematical scenarios:

- Integer arithmetic
- Fraction operations (simple, nested, mixed)
- Decimals
- Complex nested expressions

## Installation & Usage

### Prerequisites

- Node.js installed.
- `pnpm` package manager.

### Setup

1. Navigate to the `viewer` directory:
   ```bash
   cd viewer
   ```
2. Install dependencies:
   ```bash
   pnpm install
   ```

### Running the App

To start the local development server:

```bash
pnpm start
# OR
pnpm start:dev  # Details: runs with nodemon for auto-restart
```

By default, the application runs at `http://localhost:4001`.

### CLI Arguments

The `server.js` script accepts optional arguments:

- `--port <number>`: Specify the port (default: 4001).
- `--root <path>`: Specify the root directory to serve (default: current dir).

## Architecture Details

- **`src/app/main.js`**: The orchestrator that initializes adapters, event listeners, and the main render loop.
- **`src/app/surface-map/`**: Contains the complex logic for parsing the visual DOM into a structured semantic map.
  - `ElementClassifier`: Tags DOM nodes with semantic roles.
  - `SurfaceMapBuilder`: Assembles the tree of nodes.
- **`src/app/features/`**: Separates concerns into distinct modules like `rendering` (KaTeX interfacing), `events` (user input), and `engine` (communication with the math backend).

## Development

The project uses native ES Modules, meaning no bundler (Webpack/Vite) is strictly required for development. Changes to `.js` files are reflected immediately upon browser refresh (or server restart if using `nodemon`).
