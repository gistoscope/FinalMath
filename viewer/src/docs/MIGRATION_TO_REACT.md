# Migration Report: Viewer to React.js

## Executive Summary

Migrating the current Viewer application to React.js is a **Medium Complexity** task. The core logic for the "Surface Node Map" and "AST Parsing" is distinct from the UI and can be largely reused. The primary effort lies in shifting from imperative DOM manipulation and mutable global state to React's declarative rendering and immutable state management.

**Estimated Effort:** 3-5 days for a senior engineer.

## Key Migration Areas

### 1. State Management (High Priority)

**Current State:**

- Centralized mutable objects in `src/app/core/state.js` (`appState`, `selectionState`, `integerCycleState`).
- Components import and modify these objects directly.
- No automatic UI updates; updates are manually triggered (e.g., calling `renderFormula()` after state changes).

**React Strategy:**

- Move global state to a **React Context** or a lightweight store (e.g., **Zustand** or **Jotai**).
- `appState.currentLatex` becomes a primary state variable.
- Selection and Interaction states (drag, hover) should be managed within a `useInteraction` hook or context.
- **Benefit:** Automatic re-rendering when state changes, eliminating manual render calls.

### 2. Rendering Pipeline (Complex)

**Current State:**

- `renderFormula` manually injects HTML strings generated by KaTeX into a DOM container.
- `buildAndShowMap` synchronously analyzes the DOM immediately after injection.

**React Strategy:**

- Create a `<KaTeXRenderer />` component.
- Use `useLayoutEffect` to trigger `SurfaceMapBuilder` _after_ the DOM has been updated by KaTeX but _before_ the browser paints (to prevent flickering).
- **Challenge:** React's virtual DOM diffing might conflict with the `SurfaceMapBuilder` if it attempts to modify the DOM.
- **Solution:** Treat the KaTeX container as a "black box" (using `dangerouslySetInnerHTML`) and let the Surface Map logic operate on the underlying Ref, ensuring React doesn't try to manage those specific internal nodes.

### 3. Event Handling

**Current State:**

- Global event listeners (`setupGlobalEvents`, `setupContainerEvents`) attached to `document` or specific IDs.

**React Strategy:**

- Move container-specific events (click, mousedown, mouseup) to React synthetic events on the wrapping `div`.
- Use `useEffect` for global window events (resize, keydown) with proper cleanup returns.
- Refactor `src/app/features/events` to expose hooks like `useKeyboardShortcuts` or `useDragSelection`.

### 4. Component Architecture

Break down `index.html` into modular components:

- **`App.jsx`**: Main Provider wrapper.
- **`DashboardLayout.jsx`**: Layout grid.
- **`FormulaStage.jsx`**: The core interactive area.
  - `<FormulaCanvas />`: Holds the KaTeX output.
  - `<InteractionOverlay />`: (Optional) If we want to move visual highlights out of the DOM manipulation logic and into React-rendered overlays.
- **`DebugPanel.jsx`**: The hover info sidebars.
- **`LogViewer.jsx`**: TSA steps log.
- **`ControlBar.jsx`**: Buttons and test selectors.

### 5. Build System

- Replace `tiny-server.js` and `nodemon` with **Vite**.
- Vite provides hot module replacement (HMR), making development significantly faster.
- **Action:** `npm create vite@latest` to scaffold the new structure.

## Code Reuse Assessment

| Module                      | Reuse Potential  | Notes                                                                       |
| :-------------------------- | :--------------- | :-------------------------------------------------------------------------- |
| `src/app/surface-map/*`     | **High (90%)**   | Pure logic analyzing DOM nodes. Requires raw DOM element input (via Refs).  |
| `src/app/ast-parser/*`      | **High (100%)**  | Pure JS logic, no UI dependency.                                            |
| `src/app/features/engine/*` | **High (90%)**   | API calls and data transformation. Minor adapter updates needed.            |
| `src/app/features/events/*` | **Low (20%)**    | Heavy refactoring needed to switch from `addEventListener` to React events. |
| `src/app/ui/*`              | **Low (0%)**     | Needs complete rewrite from vanilla JS DOM manipulation to JSX.             |
| `src/app/core/state.js`     | **Medium (50%)** | Logic/Constants are reusable; State storage mechanism needs replacement.    |

## Recommended Migration Workflow

1.  **Initialize React App**: Create a new Vite project alongside the current one.
2.  **Port Standard Logic**: Copy `surface-map`, `ast-parser`, and `utils` to the new project.
3.  **Build Components**: implement the basic UI shell (Header, Sidebar).
4.  **Implement Rendering**: Create the `<KaTeXRenderer>` component and verify it can display formulas.
5.  **Integrate Surface Map**: Use `useRef` and `useEffect` to connect the `SurfaceMapBuilder` to the rendered formula.
6.  **Migrate State**: Re-implement `state.js` using a React Context.
7.  **Port Interactions**: Port event handlers one by one (Click, Hover, Drag).

## Conclusion

The migration is straightforward but requires careful handling of the **DOM-to-React** boundary, specifically for the `SurfaceMapBuilder`. By treating the formula visualization area as a managed imperative island within the declarative React app, you can retain the powerful existing logic while benefiting from React's modern UI capabilities.
