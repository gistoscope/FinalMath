<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Surface Node Map Demo</title>
    <link rel="stylesheet" href="./src/assets/katex/katex.min.css" />
    <link rel="stylesheet" href="./src/assets/css/style.css" />
  </head>

  <body>
    <div class="page">
      <header>
        <h1>Интерактивный тренажер</h1>
        <p>Демонстрация работы SurfaceNodeMap и TSA (NGIN Lite).</p>
      </header>

      <div class="layout">
        <section class="card">
          <h2>Display Viewer (KaTeX)</h2>
          <div class="formula-shell">
            <div id="formula-container"></div>
            <div id="drag-rect"></div>
          </div>
          <div id="hover-panel" class="hover-panel">
            <div class="hover-title">Hover / Click debug</div>
            <div class="hover-line">
              <span class="label">Hover:</span> <span id="hover-info">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Last click:</span>
              <span id="click-info">—</span>
            </div>
          </div>
          <div class="step-hint">
            <div class="step-hint-label">Step hint:</div>
            <div id="tsa-student-hint" class="step-hint-text">—</div>
          </div>

          <div id="engine-debug-panel" class="hover-panel">
            <div class="hover-title">Engine debug (FileBus)</div>
            <div class="hover-line">
              <span class="label">ClientEvent:</span>
              <span id="engine-debug-client">—</span>
            </div>
            <div class="hover-line">
              <span class="label">EngineRequest:</span>
              <span id="engine-debug-request">—</span>
            </div>
            <div class="hover-line">
              <span class="label">EngineResponse:</span>
              <span id="engine-debug-response">—</span>
            </div>
          </div>
          <div id="tsa-debug-panel" class="hover-panel">
            <div class="hover-title">TSA debug</div>
            <div class="hover-line">
              <span class="label">Operator:</span>
              <span id="tsa-debug-operator">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Strategy:</span>
              <span id="tsa-debug-strategy">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Invariant:</span>
              <span id="tsa-debug-invariant">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Invariant text:</span>
              <span id="tsa-debug-invariant-text">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Window before:</span>
              <span id="tsa-debug-before">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Window after:</span>
              <span id="tsa-debug-after">—</span>
            </div>
            <div class="hover-line">
              <span class="label">Error:</span>
              <span id="tsa-debug-error">—</span>
            </div>
            <div class="hover-line">
              <span class="label">AST nodes:</span>
              <span id="tsa-debug-ast-size">—</span>
            </div>
          </div>
          <div class="footer-note">
            Формула рендерится KaTeX, затем строится карта интерактивности по
            DOM + геометрии.
          </div>
        </section>

        <section class="card">
          <h2>TSA steps log</h2>
          <pre
            id="tsa-log-output"
            style="
              margin-top: 8px;
              padding: 10px 12px;
              max-height: 360px;
              overflow: auto;
              white-space: pre;
              background: #0f172a;
              color: #e5e7eb;
              border-radius: 8px;
              font-size: 14px;
            "
          >
—</pre
          >
        </section>

        <section class="card">
          <h2>Surface Node Map JSON</h2>
          <div class="controls">
            <label for="test-select" style="margin-right: 8px">Test:</label>
            <select id="test-select">
              <option value="0">T14 · Fraction Addition Same Denom</option>
              <option value="1">T15 · Fraction Subtraction Same Denom</option>
              <option value="2">T0 · Integers 2 + 3</option>
              <option value="3">T1 · Simple fractions</option>
              <option value="4">T2 · Nested fraction</option>
              <option value="5">T3 · Unary minus + brackets</option>
              <option value="6">T4 · Decimals</option>
              <option value="7">T5 · Mixed numbers</option>
              <option value="8">T6 · 2 + 3 - 1</option>
              <option value="9">T7 · Three fractions</option>
              <option value="10">T8 · (1-1/3)·3/4</option>
              <option value="11">T9 · 2/5 - (1/10+3/20)</option>
              <option value="12">T10 · Two bracketed groups</option>
              <option value="13">T11 · Mixed decimals & fractions</option>
              <option value="14">T12 · Stress nested</option>
              <option value="15">T13 · Extra mix</option>
            </select>

            <button id="btn-rebuild" class="primary">Rebuild map</button>
            <button id="btn-download" class="secondary">Download JSON</button>
            <button id="btn-download-events" class="secondary">
              Download events JSONL
            </button>
            <button id="btn-download-bus" class="secondary">
              Download bus JSONL
            </button>
            <button id="btn-download-snapshot" class="secondary">
              Download Step Snapshot
            </button>
            <button id="btn-download-session" class="secondary">
              Download Session Log
            </button>
            <button id="btn-reset-session" class="secondary">
              Reset Session Log
            </button>
            <button
              id="btn-clear-selection"
              class="secondary"
              style="
                background: #fecaca;
                color: #7f1d1d;
                border: 1px solid #f87171;
              "
            >
              Clear selection
            </button>
          </div>
          <div
            class="controls"
            style="
              margin-top: 10px;
              flex-direction: column;
              align-items: stretch;
            "
          >
            <label for="manual-latex-input" style="margin-bottom: 4px"
              >Manual LaTeX input:</label
            >
            <textarea
              id="manual-latex-input"
              rows="2"
              style="
                width: 100%;
                resize: vertical;
                font-family:
                  ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                  &quot;Liberation Mono&quot;, &quot;Courier New&quot;,
                  monospace;
              "
            ></textarea>
            <div style="margin-top: 6px">
              <button id="btn-load-latex" class="secondary">
                Load LaTeX into viewer
              </button>
            </div>
          </div>
          <pre id="surface-json">{ "status": "building surface map..." }</pre>
          <div class="footer-note">
            Это сериализованное дерево SurfaceNodeMap: только семантические узлы
            (числа, знаки, скобки, дробные черты и т.п.).
          </div>
        </section>
      </div>
    </div>

    <script src="./src/assets/katex/katex.min.js"></script>
    <script type="module" src="./src/app/main.js"></script>
  </body>
</html>
