<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Surface Node Map Demo</title>
  <link rel="stylesheet" href="katex/katex.min.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.08);
      border-left: 4px solid #2563eb;
    }

    header h1 {
      margin: 0 0 4px 0;
      font-size: 32px;
    }

    header p {
      margin: 0;
      font-size: 18px;
      color: #4b5563;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.06);
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }

    #formula-container {
      min-height: 260px;
      padding: 32px;
      font-size: 2.0rem;
      border-radius: 10px;
      background: linear-gradient(135deg, #eff6ff, #eef2ff);
      border: 1px solid #bfdbfe;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 22px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #surface-json {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 18px;
      background: #020617;
      color: #bbf7d0;
      border-radius: 8px;
      padding: 10px 12px;
      max-height: 480px;
      overflow: auto;
      white-space: pre;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 18px;
      color: #6b7280;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      padding: 6px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-top: 6px;
    }

    .pill strong {
      font-weight: 600;
    }


    .step-hint {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #ecfdf5;
      font-size: 16px;
    }

    .step-hint-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .step-hint-text {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .hover-panel {
      margin-top: 8px;
      padding: 12px 14px;
      border-radius: 8px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 18px;
      color: #1f2937;
    }

    .hover-panel .hover-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #1d4ed8;
    }

    .hover-panel .hover-line {
      display: flex;
      gap: 4px;
      margin-top: 2px;
    }

    .hover-panel .label {
      font-weight: 500;
      color: #4b5563;
    }

    /* Selection + drag styles */
    .mv-selected {
      outline: 2px solid rgba(16, 185, 129, 0.95);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      background-color: rgba(209, 250, 229, 0.4);
    }

    .formula-shell {
      position: relative;
    }

    #formula-container {
      position: relative;
      z-index: 1;
    }

    #drag-rect {
      position: absolute;
      border: 2px dashed rgba(37, 99, 235, 0.9);
      background-color: rgba(191, 219, 254, 0.2);
      pointer-events: none;
      display: none;
      z-index: 2;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <h1>Интерактивный тренажер</h1>
      <p>
        Демонстрация работы SurfaceNodeMap и TSA (NGIN Lite).
      </p>
    </header>

    <div class="layout">
      <section class="card">
        <h2>Display Viewer (KaTeX)</h2>
        <div class="formula-shell">
          <div id="formula-container"></div>
          <div id="drag-rect"></div>
        </div>
        <div id="hover-panel" class="hover-panel">
          <div class="hover-title">Hover / Click debug</div>
          <div class="hover-line"><span class="label">Hover:</span> <span id="hover-info">—</span></div>
          <div class="hover-line"><span class="label">Last click:</span> <span id="click-info">—</span></div>
        </div>
        <div class="step-hint">
          <div class="step-hint-label">Step hint:</div>
          <div id="tsa-student-hint" class="step-hint-text">—</div>
        </div>

        <div id="engine-debug-panel" class="hover-panel">
          <div class="hover-title">Engine debug (FileBus)</div>
          <div class="hover-line">
            <span class="label">ClientEvent:</span>
            <span id="engine-debug-client">—</span>
          </div>
          <div class="hover-line">
            <span class="label">EngineRequest:</span>
            <span id="engine-debug-request">—</span>
          </div>
          <div class="hover-line">
            <span class="label">EngineResponse:</span>
            <span id="engine-debug-response">—</span>
          </div>
        </div>
        <div id="tsa-debug-panel" class="hover-panel">
          <div class="hover-title">TSA debug</div>
          <div class="hover-line">
            <span class="label">Operator:</span>
            <span id="tsa-debug-operator">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Strategy:</span>
            <span id="tsa-debug-strategy">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Invariant:</span>
            <span id="tsa-debug-invariant">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Invariant text:</span>
            <span id="tsa-debug-invariant-text">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Window before:</span>
            <span id="tsa-debug-before">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Window after:</span>
            <span id="tsa-debug-after">—</span>
          </div>
          <div class="hover-line">
            <span class="label">Error:</span>
            <span id="tsa-debug-error">—</span>
          </div>
          <div class="hover-line">
            <span class="label">AST nodes:</span>
            <span id="tsa-debug-ast-size">—</span>
          </div>
        </div>
        <div class="footer-note">
          Формула рендерится KaTeX, затем строится карта интерактивности по DOM + геометрии.
        </div>
      </section>


      <section class="card">
        <h2>TSA steps log</h2>
        <pre id="tsa-log-output" style="
    margin-top: 8px;
    padding: 10px 12px;
    max-height: 360px;
    overflow: auto;
    white-space: pre;
    background: #0f172a;
    color: #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
  ">—</pre>
      </section>

      <section class="card">
        <h2>Surface Node Map JSON</h2>
        <div class="controls">
          <label for="test-select" style="margin-right:8px;">Test:</label>
          <select id="test-select">
            <option value="0">T14 · Fraction Addition Same Denom</option>
            <option value="1">T15 · Fraction Subtraction Same Denom</option>
            <option value="2">T0 · Integers 2 + 3</option>
            <option value="3">T1 · Simple fractions</option>
            <option value="4">T2 · Nested fraction</option>
            <option value="5">T3 · Unary minus + brackets</option>
            <option value="6">T4 · Decimals</option>
            <option value="7">T5 · Mixed numbers</option>
            <option value="8">T6 · 2 + 3 - 1</option>
            <option value="9">T7 · Three fractions</option>
            <option value="10">T8 · (1-1/3)·3/4</option>
            <option value="11">T9 · 2/5 - (1/10+3/20)</option>
            <option value="12">T10 · Two bracketed groups</option>
            <option value="13">T11 · Mixed decimals & fractions</option>
            <option value="14">T12 · Stress nested</option>
            <option value="15">T13 · Extra mix</option>
          </select>

          <button id="btn-rebuild" class="primary">Rebuild map</button>
          <button id="btn-download" class="secondary">Download JSON</button>
          <button id="btn-download-events" class="secondary">Download events JSONL</button>
          <button id="btn-download-bus" class="secondary">Download bus JSONL</button>
          <button id="btn-download-snapshot" class="secondary">Download Step Snapshot</button>
          <button id="btn-download-session" class="secondary">Download Session Log</button>
          <button id="btn-reset-session" class="secondary">Reset Session Log</button>
          <button id="btn-clear-selection" class="secondary"
            style="background: #fecaca; color: #7f1d1d; border: 1px solid #f87171;">Clear selection</button>
        </div>
        <div class="controls" style="margin-top: 10px; flex-direction: column; align-items: stretch;">
          <label for="manual-latex-input" style="margin-bottom:4px;">Manual LaTeX input:</label>
          <textarea id="manual-latex-input" rows="2"
            style="width:100%; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
          <div style="margin-top:6px;">
            <button id="btn-load-latex" class="secondary">Load LaTeX into viewer</button>
          </div>
        </div>
        <pre id="surface-json">{ "status": "building surface map..." }</pre>
        <div class="footer-note">
          Это сериализованное дерево SurfaceNodeMap: только семантические узлы
          (числа, знаки, скобки, дробные черты и т.п.).
        </div>
      </section>
    </div>
  </div>

  <script src="katex/katex.min.js"></script>
  <script type="module" src="app/main.js"></script>
</body>

</html>