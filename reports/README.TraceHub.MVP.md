# TraceHub MVP - Universal End-to-End Tracing

## Overview

TraceHub provides universal end-to-end tracing across the viewer and backend for debugging math step operations. It records structured events in ring buffers, correlates them via `traceId`, and provides download/reset/inspect capabilities.

---

## Trace Event Schema

```json
{
  "ts": "2024-12-13T23:15:00.000Z",
  "traceId": "tr-abc123",
  "stepId": "step-1702512345678",
  "module": "backend.orchestrator",
  "level": "INFO",
  "event": "ORCHESTRATOR_ENTER",
  "data": {
    "expressionLatex": "2+3",
    "selectionPath": "term[0]",
    "preferredPrimitiveId": "P.INT_TO_FRAC"
  }
}
```

### Fields

| Field | Type | Description |
|-------|------|-------------|
| `ts` | ISO string | Timestamp |
| `traceId` | string | Correlation ID per apply attempt (generated by viewer) |
| `stepId` | string/null | Backend step snapshot ID |
| `module` | string | Source module (e.g., "viewer.ui", "backend.orchestrator") |
| `level` | enum | INFO, DEBUG, TRACE |
| `event` | string | Event type (CLICK, HINT_APPLY, ORCHESTRATOR_ENTER, RUN_END, etc.) |
| `data` | object | Event-specific payload |

---

## Where Events Are Emitted

### Backend (`backend-api-v1.http-server`)

| File | Event | When |
|------|-------|------|
| `src/orchestrator/step.orchestrator.ts` | `ORCHESTRATOR_ENTER` | Entry to `runOrchestratorStep()` |

### Viewer (`viewer/app`)

| File | Event | When |
|------|-------|------|
| `traceHub.js` | (module) | Ring buffer and emit/dump/download utilities |

---

## Backend Endpoints

### GET `/debug/trace/latest`

Returns latest trace info without full buffer.

**Response:**
```json
{
  "count": 42,
  "lastTraceId": "tr-abc123",
  "lastStepId": "step-1702512345678",
  "lastNEvents": [/* last 20 events */]
}
```

### GET `/debug/trace/download`

Downloads entire trace buffer as JSONL file.

**Headers:**
- `Content-Type: application/x-ndjson`
- `Content-Disposition: attachment; filename="tracehub-2024-12-13T...jsonl"`

### POST `/debug/trace/reset`

Clears the backend trace buffer.

**Response:**
```json
{ "status": "ok", "message": "TraceHub buffer reset" }
```

---

## Debug Tool UI

The debug-tool.html page includes a **TraceHub Panel** with:

1. **Download Trace JSONL** - Downloads viewer trace buffer
2. **Reset TraceHub** - Clears viewer buffer
3. **Fetch Backend Trace** - Calls `/debug/trace/latest` and displays events

### TraceHub Panel Features

- Shows viewer event count
- Shows last `traceId` (truncated)
- Displays last 10 events with color-coded module/event names

---

## How to Verify

### 1. Start Backend & Viewer

```bash
# Terminal 1: Backend
cd D:\G\backend-api-v1.http-server
pnpm start:dev

# Terminal 2: Viewer
cd D:\G\viewer
node tiny-server.js --port 4002
```

### 2. Open Browser

- Main viewer: http://localhost:4002
- Debug tool: http://localhost:4002/debug-tool.html

### 3. Test Backend Trace Endpoints

Open debug-tool.html and:

1. Click **"Fetch Backend Trace"**
   - Should show count and events (or "No backend trace events" if fresh)

2. Click **"Reset TraceHub"**
   - Clears viewer buffer

3. Click **"Download Trace JSONL"**
   - Should download a `.jsonl` file (may be empty if no events)

### 4. Test End-to-End Flow

1. In main viewer, enter `5` and click the number
2. Open debug-tool.html
3. Click **"Fetch Backend Trace"**
4. Should see `ORCHESTRATOR_ENTER` event with `expressionLatex: "5"`

### 5. Run Backend Tests

```bash
cd D:\G\backend-api-v1.http-server
npx vitest run tests/TraceHub.test.ts
```

Expected: All tests pass.

---

## Files Created/Modified

| File | Change |
|------|--------|
| `backend-api-v1.http-server/src/debug/TraceHub.ts` | **NEW**: Ring buffer, emit, toJsonl |
| `backend-api-v1.http-server/src/server/engineHttpServer.ts` | Added `/debug/trace/*` endpoints |
| `backend-api-v1.http-server/src/orchestrator/step.orchestrator.ts` | Added `ORCHESTRATOR_ENTER` trace event |
| `backend-api-v1.http-server/tests/TraceHub.test.ts` | **NEW**: Unit tests |
| `viewer/app/traceHub.js` | **NEW**: Viewer ring buffer |
| `viewer/debug-tool.html` | Added TraceHub panel |
| `viewer/app/debug-tool.js` | Added TraceHub handlers |

---

## CORS Configuration

The backend allows `x-trace-id` header for cross-origin requests:
```typescript
res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization, x-trace-id");
```

---

## Ring Buffer Sizes

| Component | Max Events | Memory |
|-----------|------------|--------|
| Backend | 200,000 | ~40-80 MB |
| Viewer | 50,000 | ~10-20 MB |

Events older than the limit are automatically dropped (FIFO).

---

## Correlation Flow

```
Viewer                           Backend
  │                                │
  │ Generate traceId              │
  │ ─────►                        │
  │                                │
  │ POST /api/orchestrator/v5/step │
  │ x-trace-id: tr-abc123         │
  │ ─────────────────────────────►│
  │                                │
  │                   TraceHub.setContext(traceId)
  │                   emit(ORCHESTRATOR_ENTER)
  │                   ... processing ...
  │                   emit(ORCHESTRATOR_EXIT)
  │                                │
  │ ◄─────────────────────────────│
  │                                │
  │ emit(STEP_RESPONSE)           │
  │ emit(UI_RENDER)               │
  │                                │
```

All events with the same `traceId` can be correlated for end-to-end debugging.
